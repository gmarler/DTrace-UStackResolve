#!/usr/perl5/5.22.0/bin/perl

use strict;
use warnings;
use v5.22;

# VERSION

use DTrace::UStackResolve;
use Getopt::Long;

my ($execname, $output_dir, @pids, $pids_aref, $dtrace_type,
    $preserve_tempfiles, %x_options, $no_annotations, $runtime,
    $ctor_args);

GetOptions(
           # execname not currently supported
           #"execname=s", \$execname,
           "output_dir=s",       \$output_dir,
           "pids=s",             \@pids,
           "type=s",             \$dtrace_type,
           "preserve_tempfiles", \$preserve_tempfiles,
           "x=s",                \%x_options,
           "no_annotations",     \$no_annotations,
           "runtime=s",          \$runtime,
       )
         or die("Error in command line arguments");

# PODNAME: dtrace_ustack

if (defined($execname)) {
  $ctor_args->{execname} = $execname;
} elsif (scalar(@pids)) {
  $pids_aref = [ split(/,/, join(',',@pids)) ];
  say "PIDS PROVIDED: " . join (',', @$pids_aref);
  $ctor_args->{pids}      = $pids_aref;
}

unless (exists($ctor_args->{pids})) {
  say "ERROR: Usage";
  exit(1);
}

if (defined($output_dir)) {
  $ctor_args->{output_dir} = $output_dir;
}

if (defined($dtrace_type)) {
  $ctor_args->{type} = $dtrace_type;
}

if (defined($preserve_tempfiles)) {
  $ctor_args->{preserve_tempfiles} = $preserve_tempfiles;
}

foreach my $key (keys %x_options) {
  $ctor_args->{$key} = $x_options{$key};
}


my $dtus = DTrace::UStackResolve->new(
  $ctor_args
);

my $loop = $dtus->loop;

$loop->run();


