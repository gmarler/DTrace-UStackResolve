#!/usr/bin/env perl

use strict;
use warnings;
use v5.22;

# VERSION

use DTrace::UStackResolve;
use Getopt::Long;

my ($execname, $output_dir, @pids, $pids_aref, $dtrace_type, $ctor_args);

GetOptions(
           # execname not currently supported
           #"execname=s", \$execname,
           "output_dir=s", \$output_dir,
           "pids=s",       \@pids,
           "type=s",       \$dtrace_type,
       )
         or die("Error in command line arguments");

# PODNAME: dtrace_ustack

if (defined($execname)) {
  $ctor_args->{execname} = $execname;
} elsif (scalar(@pids)) {
  $pids_aref = [ split(/,/, join(',',@pids)) ];
  say "PIDS PROVIDED: " . join (',', @$pids_aref);
  $ctor_args->{pids}      = $pids_aref;
}

if (defined($output_dir)) {
  $ctor_args->{output_dir} = $output_dir;
}

if (defined($dtrace_type)) {
  $ctor_args->{type} = $dtrace_type;
}

my $dtus = DTrace::UStackResolve->new(
  $ctor_args
);

my $loop = $dtus->loop;

$loop->run();


